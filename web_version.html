<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>City Bus Manager - Text Version</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: #f2f2f2;
    font-family: system-ui, sans-serif;
  }
  body {
    display: flex;
    flex-direction: column;
  }
  #chat {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .msg {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 16px;
    word-wrap: break-word;
  }
  .bot { background: #e5e5ea; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
  .user { background: #007aff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  #input-area {
    display: flex;
    padding: 10px;
    background: white;
    border-top: 1px solid #ccc;
    flex-shrink: 0;
  }
  #input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 16px;
    padding: 8px;
  }
  #send {
    background: #007aff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0 16px;
    font-size: 16px;
    margin-left: 8px;
  }
  @media (max-width: 768px) {
    #chat { padding-bottom: 80px; }
  }
</style>
</head>
<body>
<div id="chat"></div>
<div id="input-area">
  <input id="input" type="text" placeholder="Type your response..." autocomplete="off" autofocus>
  <button id="send">Send</button>
</div>

<script type="module">
import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.mjs";

const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

let pyodide = null;

function addMessage(text, sender) {
  const div = document.createElement('div');
  div.className = `msg ${sender}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Redirect Python print() to chat
function setupPrintHook() {
  pyodide.runPython(`
import sys
class ChatRedirect:
    def write(self, text):
        from js import addMessage
        if text.strip(): addMessage(text, "bot")
    def flush(self): pass
sys.stdout = sys.stderr = ChatRedirect()
  `);
}

// Preload folders
async function preloadFolders() {
  const folders = ['dlcs_and_mods', 'running_boards', 'saves'];
  for (const folder of folders) {
    try { await pyodide.FS.mkdir(folder); } catch {}
  }
}

// Preload all Python modules properly for import
async function preloadModules() {
  const modules = [
    { path: 'running_boards.py', folder: '/' },
    { path: 'game.py', folder: '/' }
  ];
  
  for (const file of modules) {
    try {
      const resp = await fetch(file.path);
      const code = await resp.text();
      
      // Make sure folder exists
      try { await pyodide.FS.mkdir(file.folder); } catch {}
      
      // Write file into Pyodide FS
      pyodide.FS.writeFile(file.path, code);
      
      // Add folder to sys.path so Python can import
      pyodide.runPython(`import sys; sys.path.append("${file.folder}")`);
      
      addMessage(`${file.path} loaded successfully.`, 'bot');
    } catch(e) {
      addMessage(`Failed to load ${file.path}: ${e}`, 'bot');
    }
  }
}

async function initPython() {
  addMessage("City Bus Manager - Text Version", "bot");
  addMessage("Loading Python environment...", "bot");

  pyodide = await loadPyodide();
  setupPrintHook();
  await preloadFolders();
  addMessage("Folders ready.", "bot");

  await preloadModules();
  addMessage("All Python modules loaded. Game ready!", "bot");
}

async function sendCommand() {
  const cmd = input.value.trim();
  if (!cmd) return;
  addMessage(cmd, 'user');
  input.value = '';
  try {
    const result = await pyodide.runPythonAsync(cmd);
    if (result) addMessage(result, 'bot');
  } catch (err) {
    addMessage(err.toString(), 'bot');
  }
}

input.addEventListener('keydown', e => { if(e.key==='Enter') sendCommand(); });
sendBtn.addEventListener('click', sendCommand);

window.addMessage = addMessage;

initPython();
</script>
</body>
</html>